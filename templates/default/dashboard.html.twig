{% extends 'single_column.html.twig' %}

{% block before_title %}
  {% from '_macro/_action_bar.html.twig' import action_bar %}
  {{ action_bar(
    is_granted('STUDYAREA_OWNER', studyArea) ? path('app_studyarea_edit', {'studyArea': studyArea.id}) : false,
    false,
    false,
    false,
    is_granted('STUDYAREA_OWNER', studyArea) ? path('app_studyarea_remove', {'studyArea': studyArea.id}) : false,
    -1,
    is_granted('STUDYAREA_EDIT', studyArea),
    is_granted('STUDYAREA_OWNER', studyArea) ? path('app_studyarea_transferowner', { studyArea: studyArea.id }) : false
  ) }}
{% endblock %}


{% block title %}
  {{ studyArea.name }}
{% endblock %}

{% block content %}
  <h2>{{ 'dashboard.study-area-text'|trans({'%studyArea%': studyArea.name}) }}</h2>

  {% if studyArea.description is not null %}
    <div class="ltb-text-container">
      {{ studyArea.description|striptags(allowed_ckeditor_tags)|raw }}
    </div>
  {% endif %}

  <p>{{ 'dashboard.study-area-contains'|trans() }}</p>
  <ul>
    <li>
      {% if conceptCount > 0 %}<a href="{{ path('app_concept_list') }}">{% endif %}
        {{ 'dashboard.concept-count'|trans({'%count%': conceptCount}) }}
        {% if conceptCount > 0 %}</a>{% endif %}
    </li>
    <li>
      {% if abbreviationCount > 0 %}<a href="{{ path('app_abbreviation_list') }}">{% endif %}
        {{ 'dashboard.abbreviation-count'|trans({'%count%': abbreviationCount}) }}
        {% if abbreviationCount > 0 %}</a>{% endif %}
    </li>
    <li>
      {% if externalResourceCount > 0 %}<a href="{{ path('app_externalresource_list') }}">{% endif %}
        {{ 'dashboard.external-resource-count'|trans({'%count%': externalResourceCount}) }}
        {% if externalResourceCount > 0 %}</a>{% endif %}
    </li>
    <li>
      {% if learningOutcomeCount > 0 %}<a href="{{ path('app_learningoutcome_list') }}">{% endif %}
        {{ 'dashboard.learning-outcome-count'|trans({'%count%': learningOutcomeCount}) }}
        {% if learningOutcomeCount > 0 %}</a>{% endif %}
    </li>
    <li>
      {% if learningPathCount > 0 %}<a href="{{ path('app_learningpath_list') }}">{% endif %}
        {{ 'dashboard.learning-path-count'|trans({'%count%': learningPathCount}) }}
        {% if learningPathCount > 0 %}</a>{% endif %}
    </li>
    {% if is_granted('STUDYAREA_EDIT', studyArea) %}
      <li>
        {% if urlCount > 0 %}<a href="{{ path('app_studyarea_urlOverview') }}">{% endif %}
          {{ 'dashboard.url-count'|trans({'%count%': urlCount, '%brokenCount%': brokenUrlCount}) }}
          {% if urlCount > 0 %}</a>{% endif %}
      </li>
    {% endif %}
  </ul>

  <h4>{{ 'dashboard.search-concept'|trans }}</h4>
  {{ form_start(conceptForm) }}
  <div class="row">
    <div class="col-sm-12 col-md-5 col-xl-3 mt-1">
      {{ form_widget(conceptForm.concept) }}
    </div>
    <div class="col mt-1">
      <div class="float-right float-md-left">
        {{ form_widget(conceptForm.submit) }}
      </div>
    </div>
  </div>

  <script type="text/javascript">
    $('#concept_form_concept').on('change', function () {
      $('#concept_form_submit').removeAttr('disabled');
    });

    $('#concept_form_submit').on('click', function () {
      eDispatch.showConcept(parseInt($('#concept_form_concept').val()));
      return false;
    });
  </script>

  {{ form_end(conceptForm) }}

  <div class="spacer"></div>

  {% if studyAreaForm is not null %}
    <h4>{{ 'dashboard.study-area-switch'|trans }}</h4>
    {{ form_start(studyAreaForm) }}
    <div class="row">
      <div class="col-sm-12 col-md-5 col-xl-3 mt-1">
        {{ form_widget(studyAreaForm.studyArea) }}
      </div>
      <div class="col mt-1">
        <div class="float-right float-md-left">
          {{ form_widget(studyAreaForm.submit) }}
        </div>
      </div>
    </div>

    <script type="text/javascript">
      $('#studyarea_form_studyArea').on('change', function () {
        $('#studyarea_form_submit').removeAttr('disabled');
      });

      $('#studyarea_form_submit').on('click', function () {
        if (typeof inDoubleColumn !== 'undefined' && inDoubleColumn) {
          eDispatch.pageLoad(Routing.generate('_home', {'_studyArea': $('#studyarea_form_studyArea').val()}, false), {topLevel: true});
        } else {
          window.location.href = Routing.generate('_home', {'_studyArea': $('#studyarea_form_studyArea').val()}, true);
        }
        return false;
      });
    </script>

    {{ form_end(studyAreaForm) }}
  {% endif %}
{% endblock %}

{% block second_content %}
  {% if studyAreaForm is not null %}
    <div class="card container-card">
      <div class="card-body">
        {% from '_macro/_action_bar.html.twig' import new_bar %}
        {{ new_bar(path('app_studyarea_add')) }}

        <h1>{{ 'study-area.list-title'|trans }}</h1>

        <div class="table-responsive">
          <table class="table">
            <thead>
            <tr>
              <th scope="col">{{ 'study-area.name'|trans }}</th>
              <th scope="col">{{ 'study-area.owner'|trans }}</th>
              <th scope="col">{{ 'study-area.access-type'|trans }}</th>
              <th scope="col">{{ 'study-area.switch-to'|trans }}</th>
              <th scope="col">{{ 'form.edit'|trans }}</th>
              <th scope="col">{{ 'form.remove'|trans }}</th>
            </tr>
            </thead>
            <tbody>
            {% for studyArea in studyAreas %}
              <tr>
                <td>{{ studyArea.name }}</td>
                <td>
                  {% if is_granted('STUDYAREA_OWNER', studyArea) %}
                    <a href="{{ path('app_studyarea_transferowner', {'studyArea': studyArea.id}) }}"
                       data-toggle="tooltip" title="{{ 'study-area.transfer-ownership'|trans }}">
                      {{ studyArea.owner.displayName }}</a>
                  {% else %}
                    {{ studyArea.owner.displayName }}
                  {% endif %}
                </td>
                <td>{{ studyArea.accessType|capitalize }}</td>
                <td>
                  {% if studyArea.id == currentStudyArea.id %}
                    {{ 'study-area.current'|trans }}
                  {% else %}
                    <a class="top-level"
                       href="{{ path('_home', {'_studyArea': studyArea.id}) }}">{{ 'study-area.switch-to'|trans }}</a>
                  {% endif %}
                </td>
                {% if is_granted('STUDYAREA_OWNER', studyArea) %}
                  <td><a
                        href="{{ path('app_studyarea_edit', {'studyArea': studyArea.id}) }}">{{ 'form.edit'|trans }}</a>
                  </td>
                  <td><a
                        href="{{ path('app_studyarea_remove', {'studyArea': studyArea.id}) }}">{{ 'form.remove'|trans }}</a>
                  </td>
                {% else %}
                  <td></td>
                  <td></td>
                {% endif %}
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}
